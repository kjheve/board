<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>게시글 조회</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    .main-wrap {
      width: 100%;
      height: 100%;
    }

    .main-wrap h2 {
      height: 50px;
      line-height: 50px;
      text-align: center;
      background-color: rgb(200, 220, 220);
    }

    .comment-wrap h2 {
      margin-top: 20px;
      height: 50px;
      line-height: 50px;
      text-align: center;
      background-color: rgb(200, 220, 220);
    }

    #bcontent {
      width: 100%;
      height: 100%;
    }

    .btn-wrap {
      display: flex;
      justify-content: space-around;
    }

    .writer-wrap,
    .date-wrap {
      display: flex;
      justify-content: space-between;
    }

    textarea {
      padding: 5px;
    }

    .btn-wrap * {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background-color: rgb(200, 220, 220);
      color: white;
      cursor: pointer;
    }

    .btn-wrap *:hover {
      background-color: rgb(150, 220, 220);
    }

    .add-comment {
      display: flex;
      height: 100%;
    }

    .add-comment #comment {
      flex: 9;
      resize: none;
      /* 크기 조절 비활성화 */
    }

    .add-comment .addBtn {
      flex: 1;
    }

    .list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #ccc;
    }

    .item button {
      background-color: rgb(200, 220, 220);
      color: white;
      border: none;
      padding: 8px 16px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin-left: 10px;
      cursor: pointer;
    }

    .item button:hover {
      background-color: rgb(150, 220, 220);
      cursor: pointer;
    }

    #commentErrMsg {
      color : red;
      font-style: italic;
    }
  </style>
</head>

<body>
  <div class="main-wrap">
    <h2 id="title" th:text="${blog.title}"></h2>
    <form action="#" method="POST" th:object="${blog}">
      <div class="writer-wrap">
        <div><label for="blogId" th:text="#{label.blog.blogId}">글번호</label><input id="blogId" type="text"
            th:value="${blog.blogId}" disabled></div>
        <div><label for="writer" th:text="#{label.blog.writer}">작성자</label><input id="writer" type="text"
            th:value="*{writer}" readonly></div>
      </div>
      <div class="date-wrap">
        <div><label for="cdate" th:text="#{label.blog.cdate}">작성일</label><input id="cdate" type="text"
            th:value="*{#temporals.format(cdate, 'yyyy-MM-dd HH:mm:ss')}" disabled></div>
        <div><label for="udate" th:text="#{label.blog.udate}">수정일</label><input id="udate" type="text"
            th:value="*{#temporals.format(udate, 'yyyy-MM-dd HH:mm:ss')}" disabled></div>
      </div>
      <div>
        <div><label for="bcontent" th:text="#{label.blog.bcontent}">내용</label></div>
        <textarea name="bcontent" id="bcontent" rows="10" th:text="*{bcontent}" readonly></textarea>
      </div>
      <div class="btn-wrap">
        <input id="listBtn" type="button" value="목록" th:value="#{button.list}">
        <input id="updateBtn" type="button" value="수정" th:value="#{button.update}">
        <input id="deleteBtn" type="button" value="삭제" th:value="#{button.delete}">
      </div>
    </form>
  </div>

  <div class="comment-wrap">
    <h2>댓글</h2>
    <div class="add-comment">
      <!-- 댓글 등록 -->
      <textarea name="" id="comment" cols="1000" rows="3"></textarea>
      <button id="addBtn">등록</button>
    </div>
    <!-- 등록시 에러 -->
    <div id="commentErrMsg"></div>
    <!-- 댓글 목록 -->
    <ul class="commentlist">
      <!-- <li class="item item1">내용1 <strong>user01@naver.com</strong>
        <div><button>수정</button><button>삭제</button></div>
      </li>
      <li class="item item1">내용2 <strong>user02@naver.com</strong>
        <div><button>수정</button><button>삭제</button></div>
      </li>
      <li class="item item1">내용3 <strong>user03@naver.com</strong>
        <div><button>수정</button><button>삭제</button></div>
      </li> -->
    </ul>
  </div>

  <!-- 댓글 읽기 모드 남이 쓴거 보이기-->
  <template id="readMode1">
    <li class="item read">
      <div><span class="reply-writer">작성자</span><span class="reply-email">email</span></div>
      <div><span class="reply">내용</span></div>
    </li>
  </template>
  <!-- 댓글 읽기 모드 내가 쓴거 보이기-->
  <template id="readMode2">
    <li class="item read">
      <div><span class="reply-writer">작성자</span><span class="reply-email">email</span></div>
      <div><span class="reply">내용</span></div>
      <div><button class="modifyBtn">수정</button><button class="delBtn">삭제</button></div>
    </li>
  </template>
  <!-- 댓글 수정 모드 -->
  <template id="editMode">
    <li class="item edit">
      <input type="text">
      <div><button class="saveBtn">저장</button><button class="cancelBtn">취소</button></div>
    </li>
  </template>
  <!-- 댓글 삭제 모달창 -->
  <dialog id="delModal">
    <p>댓글을 삭제하시겠습니까?</p>
    <form action="" method="dialog">
      <button id="cancelBtn">취소</button>
      <button id="delItemBtn">삭제</button>
    </form>
  </dialog>


  <script th:inline="javascript">
    // ★☆★☆★☆★☆★----------스크립트 시작-----------★☆★☆★☆★☆★
    // 세션 변수
    const memberNickname = [[${ session.loginMember.nickname }]];
    // ★☆★☆★☆★☆★★☆★☆★☆★☆★★☆★☆★☆★☆★★☆★☆★☆★☆

    // 게시판 변수
    const $listBtn = document.getElementById('listBtn'); // 목록버튼
    const $updateBtn = document.getElementById('updateBtn');// 수정 버튼
    const $deleteBtn = document.getElementById("deleteBtn"); // 삭제 버튼
    const bid = document.getElementById('blogId').value; // blogId의 값 bid

    // 목록 클릭 이벤트
    $listBtn.addEventListener('click', evt => {
      location.href = '/blog';
    });

    // 수정 클릭 이벤트
    $updateBtn.addEventListener('click', evt => {
      // const bid = document.getElementById('blogId').value;
      location.href = `/blog/${bid}/edit`;
    });

    // 삭제 클릭 이벤트
    $deleteBtn.addEventListener('click', evt => {
      if (!confirm('삭제 하시겠습니까?')) {
        return; // 아니오(!false) 입력시 true로 되어 return
      }
      // const bid = document.getElementById('blogId').value;
      location.href = `/blog/${bid}/del`;
    });

    // ------------------------------------------------------------------------
    // 댓글구현--------------------------------------------------
    // 댓글 변수
    const $addBtn = document.getElementById('addBtn'); // 댓글 등록
    const $comment = document.getElementById('comment'); // 댓글 내용 textarea
    const $commentErrMsg = document.getElementById('commentErrMsg'); // 댓글 등록 에러메세지
    const $readMode1 = document.getElementById('readMode1'); // 읽기모드
    const $readMode2 = document.getElementById('readMode2'); // 읽기모드
    const $editMode = document.getElementById('editMode'); // 수정모드
    const $commentlist = document.querySelector('.commentlist'); // 댓글 목록

    const bId = document.getElementById('blogId').value; // 현재 게시글 번호 값
    const writerValue = document.getElementById('writer').value; // 작성자 값

    // const loginId = '테스트'; // 임시변수


    list(bId); // 댓글 목록 불러오기
    // 댓글 목록☆☆☆☆☆☆☆☆☆☆☆☆☆☆
    async function list(bId) {
      const url = `http://localhost:9080/api/comments?blogId=${bId}`;
      const option = {
        method: 'GET',
        headers: {
          accept: 'application/json' // json 형태로 받기
        }
      };
      try {
        const res = await fetch(url, option);
        if (!res.ok) return new Error('서버응답오류');
        const result = await res.json(); // 응답메세지 바디 json => js 객체
        if (result.header.rtcd == '00') {
          console.log(result.body); // 댓글목록 받아오기

          const html = result.body.map(comment => {
            let $readModeLi = '';
            if (comment.writer == writerValue) { // 작성자 = 로그인ID 비교
              $readModeLi = readMode2.content.cloneNode(true).querySelector('li');
            } else {
              $readModeLi = readMode1.content.cloneNode(true).querySelector('li');
            }
            $readModeLi.querySelector('.reply').textContent = comment.ccontent;
            return $readModeLi.outerHTML;
          }).join('');

          // console.log(html); // map으로 받아온거 찍어보기

          $commentlist.innerHTML = html; // 댓글 목록에 저장
        } else {
          new Error('목록 가져오기 실패!');
        }
      } catch (err) {
        console.error(err);
      }
    }

    // 댓글 등록☆☆☆☆☆☆☆☆☆☆☆☆☆☆
    $addBtn.addEventListener('click', evt => {
      // 1) 유효성 체크
      if ($comment.value.trim().length < 3) {
        $commentErrMsg.textContent = '3글자 이상 입력 바람';
        return;
      } else {
        $commentErrMsg.textContent = '';
      }
      // 2) 등록처리
      const commentContent = $comment.value;
      const comment = {
        "blogId": bId,
        "ccontent": commentContent,
        "writer": memberNickname
      }
      add(comment);
      $comment.value ='';
    });
    // 댓글 등록 함수
    async function add(comment) {
      const url = `http://localhost:9080/api/comments`;
      const payload = comment
      const option = {
        method: 'POST',
        headers: {
          'accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload),   // ★js 객체 => json 포맷 문자열
      };
      try {
        const res = await fetch(url, option);
        if (!res.ok) return new Error('서버응답오류');
        const result = await res.json(); // 응답 메세지 바디를 읽어 json포맷 문자열 => js객체
        if (result.header.rtcd == '00') {
          console.log(result.body);
          list(bId); // 성공했으니 목록을 갱신
        } else {
          new Error('등록 실패!');
        }
        // console.log(result);
      } catch (err) {
        console.err(err.message);
      }

    }


  </script>

</body>

</html>